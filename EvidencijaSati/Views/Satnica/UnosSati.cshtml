@model EvidencijaSati.Models.ViewModels.UnosSatiVM

@Scripts.Render("~/bundles/dataTables")
@Styles.Render("~/Content/dataTables")
@Styles.Render("~/Content/unosSati")

<h1>Pozdrav @Model.Djelatnik.Ime !</h1>

<div class="container">
	 <div class="row justify-content-between">
		  <div class="col col-4 dateCol">
				<p>Bilježe se sati za <b><span id="txtDatum"></span></b></p>
		  </div>
		  <div class="col col-4">
				<button id="btnPregled"
						  class="btn btn-outline-success"
						  type="button">
							Pregledaj unose na čekanju
				</button>
		  </div>
	 </div>
	 <div class="row">
		  <div class="card card-body">

				<table id="table" style="width: 100%">
					 <thead>
						  <tr>
								<th>Projekt</th>
								<th>Zabilježeno</th>
								<th>Start / Stop</th>
								<th>Radni sati</th>
								<th>Prekovremeni sati</th>
								<th>Detalji</th>
						  </tr>
						  </thead>
					 <tbody>
					 @for (int i = 0; i < Model.Projekti.Count; i++)
					 {
						  <tr class="@Model.Projekti[i].IDProjekt rowProjekt">
								<td>@Model.Projekti[i].Naziv</td>
								<td id="@("txtZab" + Model.Projekti[i].IDProjekt)" class="zabiljezeno">
									 @(Model.Satnica.ProjektZabiljezeno[Model.Projekti[i].IDProjekt])
								</td>
						  	 	<td>
								<button id="@("btnProjekt" + Model.Projekti[i].IDProjekt)"
										  class="btn btn-success btnTimer @i"
										  type="button">Start
								</button>
								</td>
						  	 	<td>
									 <input id="@("txtRadni" + Model.Projekti[i].IDProjekt.ToString())"
											  class="form-control"
											  type="text" />
								</td>
								<td>
									 <input id="@("txtPrekovremeni" + Model.Projekti[i].IDProjekt.ToString())"
												class="form-control"
												type="text" />
								</td>
						  	 	<td><a href="#"><i class="fa fa-info-circle fa-3x" style="color: grey;"></i></a></td>
						  </tr>
					 }
					 </tbody>
					 <tfoot>
						  <tr>
								<td>Ukupno</td>
								<td><b>@Model.Satnica.GetFormatedProperties("total")</b></td>
								<td></td>
								<td><b></b></td>
								<td><b></b></td>
								<td></td>
						  </tr>
					 </tfoot>
				</table>

		  </div>
		  </div>
	 <div class="row btns justify-content-center">
		  <div class="col col-4">
			 <button id="btnOdustani"
						class="btn btn-outline-danger">Odustani</button>
		  </div>
		  <div class="col col-4">
			 <button id="btnSpremi"
						class="btn btn-primary">Spremi</button>
		  </div>
		  <div class="col col-4">
			 <button id="btnPredaj"
						class="btn btn-warning">Predaj</button>
		  </div>
	 </div>

</div>

<script type="text/javascript">


	 $(document).ready(function () {

		  var datum = "@Model.Satnica.Datum.ToString()".split(" ")[0];
		  $('#txtDatum').html(datum);

		  $('#btnPredaj').prop('disabled', true);
		  //$('#btnSpremi').prop('disabled', true);

		  var projectId, start, end;

		  var table = $("#table").DataTable({
				select: true,
				paging: false,
				ordering: false,
				info: false,
				searching: false,
				columnDefs: [
					 {
						  targets: 1,
						  className: 'dt-body-center'
					 },
					 {
						  targets: 3,
						  className: 'dt-body-center'
					 },
					 {
						  targets: 4,
						  className: 'dt-body-center'
					 },
					 {
						  targets: 5,
						  className: 'dt-body-center'
					 }
				]
		  });

		  $('button.btnTimer').click(function (e) {
				e.preventDefault();

				if ($(this).hasClass('btn-success')) {
					 start = new Date();
					 projectId = this.id.split('btnProjekt')[1];

					 $(this).removeClass('btn-success');
					 $(this).addClass('btn-danger');
					 $(this).html('Stop');

					 $('button.btn-success').prop('disabled', true);

				} else {
					 end = new Date();

					 $('button.btn-success').prop('disabled', false);

					 $(this).removeClass('btn-danger');
					 $(this).addClass('btn-success');
					 $(this).html('Start');


					 var model = {
						  IDSatnicaProjekta: -1,
						  SatnicaID: @Model.Satnica.IDSatnica,
						  ProjektID: projectId.toString(),
						  Start: start,
						  End: end
					 };


					 $.ajax({
						  url: "@Url.Action("SpremiTempSatnicu")",
						  method: "POST",
						  data: JSON.stringify(model),
						  contentType: 'application/json',
						  success: function (res) {
								//res[0] row
								//res[1] zabiljezeno
								//res[2] prekovremeno
								//res[3] projID

								table.cell(res[0], 1, 0).data(addHoursMinutes(table.cell(res[0], 1, 0).data(), res[1])).draw();

								var txtR = "#txtRadni" + res[3];
								var txtP = "#txtPrekovremeni" + res[3];

								$(txtR).val(res[1]);
								$(txtP).val(res[2]);					

						  }
					 });


				}

		  });

		  $('#btnSpremi').on('click', function (e) {
				e.preventDefault();
				const regex = new RegExp('\\d{1,2}[:]\\d{1,2}');

				$('input').each(function (i) {
					 if (regex.test($(this).val())) {
						  $('button.btnTimer').prop('disabled', true);
						  lockTextFields(true);
						  $('#btnSpremi').prop('disabled', true);
						  $('#btnPredaj').prop('disabled', false);
					 } else {
						  alert("krivi unos");
						  return false;
					 }
				});
		  });

		  $('#btnOdustani').on('click', function (e) {
				e.preventDefault();
				$('button.btnTimer').prop('disabled', false);
				$('input').each(function (i) {
					 $(this).val("00:00");
				});
				lockTextFields(false);
				$('#btnSpremi').prop('disabled', false);
				$('#btnPredaj').prop('disabled', true);
		  });

		  $('#btnPredaj').on('click', function (e) {
				e.preventDefault();
				$('#btnPredaj').prop('disabled', tru);
		  });

	 });

	 function isProject(id) {
		  return (id == 'btnBolovanje' || id == 'btnGodisnji' || id == 'btnPutovanje');
	 }

	 function addHoursMinutes(first, second) {
		  var f = first.split(':');
		  var s = second.split(':');

		  var fH = parseInt(f[0]);
		  var sH = parseInt(s[0]);
		  var fM = parseInt(f[1]);
		  var sM = parseInt(s[1]);

		  var newH = fH + sH;
		  var newM = fM + sM;

		  return newH.toString().padStart(2, '0') + ":" + newM.toString().padStart(2, '0')

	 }

	 function lockTextFields(trueFalse) {
		  if (trueFalse) {
				$('input').each(function (i) {
					 $(this).prop('disabled', true);
				});
		  } else {
				$('input').each(function (i) {
					 $(this).prop('disabled', false);
				});
		  }
	 }


</script>